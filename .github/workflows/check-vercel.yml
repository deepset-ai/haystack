name: Vercel Deployment Check

on:
  deployment_status:

jobs:
  vercel-pr-deployment:
    runs-on: ubuntu-latest
    steps:
      - name: Check if deployment is for a PR
        env:
          PR_URLS: ${{ toJSON(github.event.deployment.pull_request_urls) }}
        run: |
          echo "Deployment pull_request_urls: $PR_URLS"

          if [ "$PR_URLS" = "null" ] || [ "$PR_URLS" = "[]" ]; then
            echo "⚠️ Deployment not associated with a PR, skipping job."
            exit 0
          fi

          echo "✅ Deployment is associated with a PR, continuing..."

      - name: Check deployment state
        run: |
          state="${{ github.event.deployment_status.state }}"
          echo "Deployment state: $state"

          case "$state" in
            success)
              echo "✅ Deployment succeeded"
              ;;
            failure|error)
              echo "❌ Deployment failed"
              exit 1
              ;;
            inactive)
              echo "ℹ️ Deployment skipped or inactive"
              ;;
            pending|queued)
              echo "⏳ Deployment still in progress"
              exit 0  # Optional: can re-trigger on next status update
              ;;
            *)
              echo "ℹ️ Unknown state: $state"
              ;;
          esac

      - name: Output deployment URL
        run: |
          url="${{ github.event.deployment_status.target_url }}"
          echo "Deployment URL: $url"
