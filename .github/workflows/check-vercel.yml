name: Wait for Vercel Deployment

on:
  pull_request:

jobs:
  wait-for-vercel:
    runs-on: ubuntu-latest

    steps:
      - name: Wait for Vercel deployment result
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          set -e

          MAX_ATTEMPTS=40
          SLEEP_SECONDS=15

          attempt=1
          while [ $attempt -le $MAX_ATTEMPTS ]; do
            echo "üîÑ Checking deployment status ($attempt/$MAX_ATTEMPTS)..."

            # Get deployments associated with this PR
            deployments=$(curl -s \
              -H "Authorization: Bearer $GH_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/$REPO/deployments")

            deployment_id=$(echo "$deployments" | jq -r '
              .[]
              | select(.pull_request_urls[]? | contains("/pulls/'"$PR_NUMBER"'"))
              | .id
            ' | head -n 1)

            if [ -z "$deployment_id" ]; then
              echo "‚è≥ No Vercel deployment created yet"
              sleep $SLEEP_SECONDS
              attempt=$((attempt + 1))
              continue
            fi

            statuses=$(curl -s \
              -H "Authorization: Bearer $GH_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/$REPO/deployments/$deployment_id/statuses")

            state=$(echo "$statuses" | jq -r '.[0].state')

            echo "‚ÑπÔ∏è deployment state=$state"

            case "$state" in
              success)
                echo "‚úÖ Vercel deployment succeeded"
                exit 0
                ;;
              inactive)
                echo "‚úÖ Vercel deployment skipped"
                exit 0
                ;;
              failure)
                echo "‚ùå Vercel deployment failed"
                exit 1
                ;;
              *)
                echo "‚è≥ Deployment still in progress"
                ;;
            esac

            sleep $SLEEP_SECONDS
            attempt=$((attempt + 1))
          done

          echo "‚ùå Timed out waiting for Vercel deployment"
          exit 1
