name: Wait for Vercel Deployment Outcome

on:
  pull_request:

jobs:
  vercel-status:
    runs-on: ubuntu-latest

    steps:
      - name: Check Vercel deployment status
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          set -e

          MAX_ATTEMPTS=40
          SLEEP_SECONDS=15

          attempt=1
          while [ $attempt -le $MAX_ATTEMPTS ]; do
            echo "üîÑ Checking Vercel deployment ($attempt/$MAX_ATTEMPTS)..."

            deployments=$(curl -s \
              -H "Authorization: Bearer $GH_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/$REPO/deployments")

            # Find a deployment associated with this PR
            deployment_id=$(echo "$deployments" | jq -r '
              .[]
              | select(.pull_request_urls[]? | endswith("/pulls/'"$PR_NUMBER"'"))
              | .id
            ' | head -n 1)

            # ‚úÖ No deployment = skipped = OK
            if [ -z "$deployment_id" ]; then
              echo "‚úÖ No deployment found (skipped)"
              exit 0
            fi

            statuses=$(curl -s \
              -H "Authorization: Bearer $GH_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/$REPO/deployments/$deployment_id/statuses")

            state=$(echo "$statuses" | jq -r '.[0].state')

            echo "‚ÑπÔ∏è deployment state=$state"

            case "$state" in
              success)
                echo "‚úÖ Deployment succeeded"
                exit 0
                ;;
              failure|error)
                echo "‚ùå Deployment failed"
                exit 1
                ;;
              pending|queued)
                echo "‚è≥ Deployment in progress"
                ;;
              *)
                echo "‚è≥ Waiting (state=$state)"
                ;;
            esac

            sleep $SLEEP_SECONDS
            attempt=$((attempt + 1))
          done

          echo "‚ùå Timed out waiting for deployment"
          exit 1
